com-diag-hazer
==============

Parse common NMEA strings and some UBX messages from GNSS devices.

[![Say Thanks!](https://img.shields.io/badge/Say%20Thanks-!-1EAEDB.svg)](https://saythanks.io/to/coverclock)

# Copyright

Copyright 2017-2019 by the Digital Aggregates Corporation, Colorado, USA.

# License

Licensed under the terms in LICENSE.txt. 

# Contact

Chip Overclock    
Digital Aggregates Corporation    
3440 Youngfield Street, Suite 209    
Wheat Ridge CO 80033 USA    
http://www.diag.com    
mailto:coverclock@diag.com    

# Abstract

This file is part of the Digital Aggregates Corporation Hazer
project. Hazer is a C-based parser of data streams that conform
to the National Marine Electronics Association (NMEA) 0183 4.10
specification. NMEA 0183 describes the output produced by most receiving
devices of Global Navigation Satellite Systems (GNSS), of which the
U.S. Global Positioning System (GPS), formerly known as Navstar, is an
example. Hazer includes a gpstool utility to display the interpreted GNSS
data. gpstool accepts NMEA sentences from standard input, from serial(ish)
devices, or from a UDP socket.

gpstool also includes the ability to recognize binary data streams in UBX
format, a proprietary data format generated by devices made by U-Blox,
a Swiss designer and manufacturer of GNSS receivers. UBX is supported by a
parallel stack called Yodel that is included in the Hazer project. gpstool
uses both the Hazer stack and the Yodel stack to process both NMEA and
UBX messages interleaved in the same data stream.

If you're wondering why I don't use the excellent open source GPS Daemon
(gpsd) and its GPS Monitor (gpsmon), the answer is: I have, in many
projects, typically in conjunction with the open source NTPsec Daemon
(ntpd). Hazer was developed as an excuse for me to learn in detail
more about how GPS works and how NMEA and UBX sentences are formatted
(because I only learn by doing), and also to develop an NMEA and UBX
parsing library that I can incorporate into the kinds of embedded systems
I am frequently called to work upon. Hazer and gpstool have also turned
out to be really useful tools for testing and evaluating GPS devices.

This software is an original work of its author(s).

# Dependencies

The Hazer library (including both Hazer and Yodel) depends on no more
than the usual standard C, GNU, and POSIX libraries.

The gpstool utility is built on top of the Hazer library and also
my Diminuto library. Diminuto is a general purpose C-based systems
programming library that supports serial port configuration, socket-based
communication, and a passle of other useful stuff. gpstool is an
excellent example of how to leverage Diminuto to get a lot done in not
so much C code. I use Diminuto in virtually all of my C-based projects,
and sometimes in other languages too that support C-linkage.  Portions of
Diminuto have also shipped in products from several of my clients.

You will seem some references to Tumbleweed. Tumbleweed is a project to
apply Hazer and Yodel to Differential GNSS (DGNSS) using the Ardusimple
SimpleRTK2B.  The SimpleRTK2B board incorporates the U-Blox UBX-ZED-F9P
multi-band GNSS receiver. The U-Blox 9 supports sending and receiving
RTCM messages between peer receivers containing Real-Time Kinematic
(RTK) measurements. This can potentially yield very accurate position
fixes, possibly down to the centimeter level. While the SimpleRTK2B is
marketed primarily to the drone enthusiasts, I am mostly interested in
it for purposes of surveying and agriculture.  Tumbleweed doesn't merit
its own repository, but having its own project name made keeping track
of it easier.

Hazer (and Diminuto) have also been used in other Digital Aggregates
projects that do have their own repositories, for example: Obelisk,
Hourglass, Candleclock, Astrolabe, and Critter.

# Repositories

<https://github.com/coverclock/com-diag-hazer>

<https://github.com/coverclock/com-diag-diminuto>

# Sentences

Hazer recognizes the following received NMEA sentences.

* GGA - Global Positioning System Fix Data (NMEA 0183 Version 4.10 p. 68)
* GLL - Geographic Position - Latitude/Longitude (NMEA 0183 Version 4.10 p. 87)
* GSA - GNSS DOP and Active Satellites (NMEA 0183 Version 4.10 p. 92)
* GSV - GNSS Satellites In View (NMEA 0183 Version 4.10 p. 96)
* RMC - Recommended Minimum Specific GNSS Data (NMEA 0183 Version 4.10 p. 113)
* TXT - Text Transmission (NMEA 0183 Version 4.10 p. 124)
* VTG - Course Over Ground & Ground Speed (NMEA 0183 Version 4.10 p. 127)

Yodel recognizes the following received UBX messages.

* UBX-ACK-ACK - Acknowledge UBX input and indicate success. (UBX 9 p. 38)
* UBX-ACK-NAK - Acknowledge UBX input and indicate failure. (UBX 9 p. 38)
* UBX-CFG-VALGET - Get Configuration Value. (UBLOX 9 p. 85)
* UBX-MON-VER - Monitor hardware and software Version. (UBLOX 9 p. 139)
* UBX-NAV-HPPOSLLH - Report high precision position and altitude. (UBX 9 p. 145)
* UBX-NAV-SVIN - Report Survey-in status on DGNSS Base. (UBLOX 9 p. 163)
* UBX-RXM-RTCM - RXM RTCM input status on DGNSS Rover. (UBLOX 9 p. 181)
* UBX-MON-HW - Monitor Hardware to detect jamming. (UBLOX 8 R15 p. 285)
* UBX-NAV-STATUS - Report Status to detect spoofing. (UBLOX 8 R15 p. 316)

# Talkers

Hazer recognizes the following talkers as belonging to the corresponding
constellations and systems.

These talkers have been observed in the wild coming from actual GPS receivers.

* GA - Galileo (as in Galileo Galilei) - EU
* GB - BeiDou (as in The Big Dipper) - China
* GL - Globalnaya Navigazionnaya Sputnikovaya Sistema (GLONASS) - Russia
* GN - Global Navigation Satellite System (GNSS) - Generic
* GP - Global Positioning System (NavStar GPS) - USA

Support for these talkers has been unit tested but has never been exercised
using actual GPS receivers.

* BD - BeiDou (as in The Big Dipper) - China
* QZ - Quasi-Zenith Satellite System (QZSS) - Japan

# Identifiers

Hazer recognizes the following satellite identifiers in the GSA and GSV
messages.

These satellite identifiers have been observed in the wild coming from actual
GPS receivers.

* GPS - 1..32
* SBAS - 33..64
* GLONASS - 65..96

Support for these satellite identifiers has been unit tested but has never been
exercised using actual GPS receivers.

* IMES - 173..182
* QZSS - 193..197
* BeiDou - 201..235
* Galileo - 301..336
* BeiDou - 401..437

However, receivers that implement the GSA System ID field introduced in
NMEA 4.10 may reuse satellite identifiers (e.g. I see GPS and Galileo both
using identifier 9 on the U-Blox 9 receiver). Despite NMEA and vendor
documentation to the contrary, I do not find the satellite identifer convention
reliable and only use it as a last resort.

# Devices

Hazer has been successfully tested with the following GPS chipsets.

* Quectel L80-R    
* SiRF Star II    
* SiRF Star III    
* SiRF Star IV    
* U-Blox 6    
* U-Blox 7    
* U-Blox 8    
* U-Blox 9

Hazer has been successfully tested with the following serial-to-USB chipsets
used by GPS devices.

* Cygnal Integrated Products    
* FTDI    
* Prolific    
* U-Blox (apparently integrated into the GPS chip itself)    

Hazer has been successfully tested with the following GPS devices.

* GlobalSat BU-353S4 (SiRF Star IV/Prolific, 4800 8N1, v067Bp2303, ttyUSB, 1Hz) [0] [1]    
* GlobalSat ND-105C (SiRF Star III/Prolific, 4800 8N1, v067Bp2303, ttyUSB, 1Hz) [0]    
* GlobalSat BU-353S4-5Hz (SiRF Star IV/Prolific, 115200 8N1, v067Bp2303, ttyUSB, 5Hz) [0]   
* Stratux Vk-162 Gmouse (U-Blox 7, 9600 8N1, v1546p01A7, ttyACM, 1Hz) [2]    
* Eleduino Gmouse (U-Blox 7, 9600 8N1, v1546p01A7, ttyACM, 1Hz) [2]    
* Generic Gmouse (U-Blox 7, 9600 8N1, v1546p01A7, ttyACM, 1Hz) [2]    
* Pharos GPS-360 (SiRF Star II/Prolific, 4800 8N1, v067BpAAA0, ttyUSB, 1Hz) [3]    
* Pharos GPS-500 (SiRF Star III/Prolific, 4800 8N1, v067BpAAA0, ttyUSB, 1Hz) [3]    
* MakerFocus USB-Port-GPS (Quectel L80-R/Cygnal, 9600 8N1, v10C4pEA60, ttyUSB, 1Hz) [2] [6]    
* Sourcingbay GM1-86 (U-Blox 7, 9600 8n1, p1546v01A7, ttyACM, 1Hz) [2]    
* Uputronics Raspberry Pi GPS Expansion Board v4.1 (U-Blox M8, 9600 8n1, N/A, ttyAMA, 1Hz) [4]    
* Jackson Labs Technologies CSAC GPSDO (U-Blox LEA-6T, 115200 8n1, N/A, ttyACM, 1Hz)    
* Garmin GLO (unknown, Bluetooth, N/A, rfcomm, 10Hz) [4]    
* NaviSys GR-701W (U-Blox 7/Prolific, 9600 8N1, v067Bp2303, ttyUSB, 1Hz) [5] [7] [8]    
* TOPGNSS GN-803G (U-Blox UBX-M8030-KT, 9600 8N1, v1546p01a8, ttyACM, 1Hz) [2] [4] [8]    
* GlobalSat BU-353W10 (U-Blox UBX-M8030, 9600 8N1, v1546p01a8, ttyACM, 1Hz) [0] [1] [2] [4] [8]
* Ardusimple SimpleRTK2B (U-Blox UBX-ZED-F9P, 9600 8N1, v1516p01a9, ttyACM, 1Hz) [2] [8] [10]

Hazer has been successfully tested with the following software defined
radio (SDR) configurations.

* Ettus Research USRP B210, GNURadio 3.7.11, GNSS-SDR 0.0.10 [9]

Footnotes:

[0] GlobalSat is the company formerly known as USGlobalSat.    
[1] An excellent all around GPS receiver easily acquired from numerous outlets.    
[2] Emits all sorts of interesting stuff in unsolicited $GPTXT or $GNTXT sentences.    
[3] Install udev rules in overlay to prevent ModemManager from toying with device.    
[4] Receives GPS (U.S.) *and* GLONASS (Russia) constellations concurrently.    
[5] Receives GPS (U.S.) *or* GLONASS (Russia) constellations via configuration.    
[6] Supports One Pulse Per Second (1PPS) by toggling digital output pin.    
[7] Supports One Pulse Per Second (1PPS) by toggling Data Carrier Detect (DCD).    
[8] Supports UBX.    
[9] Hardware from National Instruments.    
[10] Receives GPS (U.S.), GLONASS (Russia), Galileo (EU), *and* BeiDou (China) simultaneously.

# Platforms

Various releases of Hazer have been tested on one or more the following targets
and platforms.

"Mercury"    
Dell OptiPlex 7040    
Intel Core i7-6700T x86_64 @ 2.8GHz x 4 x 2    
Ubuntu 14.04.4 "Trusty Tahr"    
Linux 4.2.0    
gcc 4.8.4    

"Nickel"    
Intel NUC5i7RYH    
Intel Core i7-5557U x86_64 @ 3.10GHz x 2 x 2    
Ubuntu 16.04.2 "Xenial Xerus"    
Linux 4.10.0    
gcc 5.4.0    

"Nickel" (updated)    
Intel NUC5i7RYH    
Intel Core i7-5557U x86_64 @ 3.10GHz x 2 x 2    
Ubuntu 18.04.1 "Bionic Beaver"    
Linux 4.15.0    
gcc 7.3.0    

"Bronze"    
Raspberry Pi 2 Model B    
Broadcom BCM2836 Cortex-A7 ARMv7 @ 900MHz x 4    
Raspbian 8.0 "Jessie"    
Linux 4.4.34    
gcc 4.9.2    

"Zinc" or "Lead"    
Raspberry Pi 3 Model B    
Broadcom BCM2837 Cortex-A53 ARMv7 @ 1.2GHz x 4    
Raspbian 8.0 "Jessie"    
Linux 4.4.34    
gcc 4.9.2    

"Gold"    
Raspberry Pi 3 Model B+    
Broadcom BCM2837B0 Cortex-A53 ARMv7 @ 1.4GHz x 4    
Raspbian 9.4 "Stretch"    
Linux 4.14.34    
gcc 6.3.0    

"Cadmium"    
Intel NUC7i7BNH    
Intel Core i7-7567U x86_64 @ 3.50GHz x 2 x 2    
Ubuntu 16.04.5 "Xenial Xerus"    
Linux 4.15.0    
gcc 5.4.0    

# Articles

Chip Overclock, "Better Never Than Late",
<http://coverclock.blogspot.com/2017/02/better-never-than-late.html>

Chip Overclock, "Time and Space",
<https://coverclock.blogspot.com/2017/09/time-space.html>

Chip Overclock, "A Menagerie of GPS Devices",
<https://coverclock.blogspot.com/2018/04/a-menagerie-of-gps-devices-with-usb.html>

Chip Overclock, "Practical Geolocation",
<https://coverclock.blogspot.com/2018/08/practical-geolocation.html>

Chip Overclock, "Pratical Geolocation II",
<https://coverclock.blogspot.com/2018/08/practical-geolocation-ii.html>

Chip Overclock, "We Have Met the Enemy and He Is Us",
<https://coverclock.blogspot.com/2018/09/we-have-met-enemy-and-he-is-us.html>

Chip Overclock, "GPS Satellite PRN 4",
<https://coverclock.blogspot.com/2018/11/gps-satellite-prn-4.html>

# Media

Adam Hart-Davis, "The Clock That Changed the World", A History of the World,
BBC, video, <https://youtu.be/T-g27KS0yiY>

John Sloan, "GN803G and Hazer 8.0.0", video, <https://youtu.be/ZXT_37PvmhE>

John Sloan, "GPS Receiver Gallery", album, <https://flic.kr/s/aHsmvoXqSH>

John Sloan, "Hazer", album, <https://flic.kr/s/aHskRMLrx7>

John Sloan, "Hazer Test 2017-02-15 15:45 UTC", video,
<https://youtu.be/UluGfpqpiQw>

John Sloan, "NGS KK1770", album, <https://flic.kr/s/aHskTG9K1h>

John Sloan, "NTP Clock Gallery, album, <https://flic.kr/s/aHsmgrizkL>

John Sloan, "Time and Space", album, <https://flic.kr/s/aHsm3ghwxP>

John Sloan, "Time and Space", video, <https://youtu.be/szoT23ZBcVU>

John Sloan, "Tumbleweed", album, <https://flic.kr/s/aHsmcdEgq6>

# References

Paul E. Ceruzzi, *GPS*, MIT Press, 2018

M. Dunn at al., "Navstar GPS Space Segment/Navigation User Interfaces",
IS-GPS-200H, Global Positioning Systems Directorate / Systems Engineering &
Integration, 2013-09-24

Mohinder S. Gerwal et al., *Global Navigation Satellite Systems, Inertial
Navigation, and Integration*, Wiley, 2013

John G. Grimes et al., *Global Position System Standard Positioning Service
Performance Standard*, 4th edition, 2008-09

IGS et al., "RINEX - The Receiver Independent Exchange Format", Version 3.03,
RTCM-SC104, 2015-07-14

Elliott D. Kaplan ed., *Understanding GPS principles and Applications*, Artech
House, 1996

Greg Milner, *Pinpoint: How GPS is Changing Technology, Culture, and Our Minds*,
W. W. Norton, 2017-05-16

NMEA 0183, "Standard for Interfacing Marine Electronic Devices", Version 4.10,
National Marine Electronics Association, 2012

NovAtel, "An Introduction to GNSS", 2nd ed., NovAtel Inc., 2015

RTCM 10403.3, "Differential GNSS (Global Navigation Satellite Systems) Services -
Version 3", 141-2016-SC104-STD, 2016-10-07

RTCM 10410.1, "Networked Transport of RTCM via Internet Protocol (NTRIP) -
Version 2.0", 111-2009-SC104-STD + 139-2011-SC104-STD, 2011-06-28

SAE 6857, "Requirements for a Terrestrial Based Positioning, Navigation, and
Timing (PNT) System to Improve Nagivation Solutions and Ensure Critical
Infrastructure Security", SAE6857, 2018-04

u-blox 7, "Receiver Description Including Protocol Specification V14",
GPS.G7-SW-12001-B, ublox, 65525, 2013-02-01

u-blox 8, "Receiver Description Including Protocol Specification",
v15-20.30.22-23.01, UBX-13003221-R15, ublox, 26415b7, 2018-03-06

u-blox 9, "ZED-F9P Interface Description", UBX-18010854-R05,
ublox, 6cc4473, 2018-12-20

u-blox 9 integration, "ZED-F9P Integration Manual", UBX-18010802-R03,
ublox, 2018-12-20

# Resources

<http://www.catb.org/gpsd/NMEA.txt>

<http://www.catb.org/gpsd/NMEA.html>

<https://support.google.com/earth/answer/148095>

<http://earth.google.com/intl/ar/userguide/v4/index.htm>

<http://static.googleusercontent.com/media/earth.google.com/en//userguide/v4/google_earth_user_guide.pdf>

<https://support.google.com/earth/answer/168344>

<https://dl.google.com/earth/client/GE7/release_7_1_8/googleearth-pro-7.1.8.3036.dmg>

<https://support.google.com/maps/answer/18539>

<https://fossies.org/linux/misc/gpsd-3.17.tar.gz/gpsd-3.17/test/daemon/beidou-gb.log>

<http://ktuukkan.github.io/marine-api/0.9.0/javadoc/net/sf/marineapi/nmea/sentence/TalkerId.html>

<https://github.com/mvglasow/satstat/wiki/NMEA-IDs>

<https://pilotweb.nas.faa.gov/PilotWeb/noticesAction.do?queryType=ALLGPS&formatType=ICAO>

<https://www.rapidtables.com/convert/number/degrees-to-degrees-minutes-seconds.html>

<https://in-the-sky.org/satmap_radar.php> Note: when using the "Live
Map of Satellite Positions" page, "Satellites above your horizon" tab,
the displayed view is as if you are looking *upwards* into the sky. This
means that the azimuth, which starts at 0 degrees at North, increases
in the *counter clockwise* direction. This is probably obvious to the
astronomers in the audience, but it wasn't to me.

<https://www.gpsworld.com/the-almanac/>

<https://en.wikipedia.org/wiki/Global_Positioning_System>

<https://en.wikipedia.org/wiki/List_of_GPS_satellites>

<https://gssc.esa.int/navipedia/index.php/GPS_Navigation_Message>

<ftp://ftp.agi.com/pub/Catalog/Almanacs/SEM/GPSAlmanac.al3>

<https://www.navcen.uscg.gov/?pageName=gpsAlmanacs>

<https://www.notams.faa.gov/dinsQueryWeb/>

<https://navcen.uscg.gov/?Do=constellationStatus>

<https://celestrak.com/GPS/NANU/description.php>

<https://www.rtca.org/sites/default/files/intentional_gps_interference_approved.pdf>

<https://github.com/mvglasow/satstat/wiki/NMEA-IDs>

<https://web.archive.org/web/20130225182002/http://www.colorado.edu/geography/gcraft/notes/gps/gpseow.htm>

<https://www.novatel.com/support/knowledge-and-learning/published-papers-and-documents/unit-conversions/>

<http://geostar-navi.com/files/docs/geos5/GeoS_NMEA_protocol_v4_0_eng.pdf>

<http://ozzmaker.com/wp-content/uploads/2016/08/M10478-M10578-NMEA_Sentence_Output.pdf>

<https://drotek.gitbook.io/rtk-f9p-positioning-solutions/tutorials/updating-zed-f9p-firmware>

<https://www.ardusimple.com/simplertk2b-hookup-guide/>

<https://www.ardusimple.com/question/xbee-usage-documentation-for-simplertk/>

<https://www.ardusimple.com/question/problem-in-configuring-base-in-time-mode-sending-out-rtcm3-messages-from-base/>

<https://www.ardusimple.com/question/both-units-now-blink-gps-to-xbee-but-no-xbee-to-gps/>

<https://www.digi.com/resources/documentation/Digidocs/90001456-13/concepts/c_transparent_mode_detailed.htm?tocpath=XBee%20transparent%20mode%7CXBee%20transparent%20mode%20in%20detail%7C_____0>

<https://www.ngs.noaa.gov/NGSDataExplorer/>

<https://github.com/digidotcom/xbee_ansic_library>

# Build

Clone and build Diminuto (used by gpstool although not by libhazer).

    cd ~
    mkdir -p src
    cd src
    git clone https://github.com/coverclock/com-diag-diminuto
    cd com-diag-diminuto/Diminuto
    make pristine depend all

Clone and build Hazer. (If you don't build Diminuto where the Hazer Makefile
expects it, some minor Makefile hacking might be required.)

    cd ~
    mkdir -p src
    cd src
    git clone https://github.com/coverclock/com-diag-hazer
    cd com-diag-hazer/Hazer
    make pristine depend all

Set up environment and run tests and utilities. (This establishes the paths
for both the Hazer and the Diminuto executables.)

    cd ~/src/com-diag-hazer/Hazer
    . out/host/bin/setup
    unittest-checksum
    unittest-format
    unittest-nmea
    unittest-parse
    unittest-tokenize
    gpstool -?

Optionally install Diminuto and Hazer in /usr/local. (I never do this myself.)

    cd ~/src/com-diag-diminuto/Diminuto
    sudo make install
    cd ~/src/com-diag-hazer/Hazer
    sudo make install

# Directories
 
* bin - utility source files.
* cfg - configuration makefiles.
* dat - NMEA and UBX output captured from actual receivers.
* fun - functional test source files.
* inc - public header files.
* out - build artifacts.
* fs - file system overlay that may be useful on the host on which Hazer runs.
* src - feature implementation and private header source files.
* tst - unit test source files (does not require a GPS receiver).

# Artifacts

* out/TARGET/arc - object file archives for static linking.
* out/TARGET/bin - utility stripped binary executables and scripts.
* out/TARGET/dep - make dependencies.
* out/TARGET/fun - functional test binary executables and scripts.
* out/TARGET/gen - generated source files.
* out/TARGET/inc - include (header) files.
* out/TARGET/lib - shared objects for dynamic linking.
* out/TARGET/log - log files produced at run-time.
* out/TARGET/obc - object files.
* out/TARGET/sym - utility unstripped binary executables.
* out/TARGET/tst - unit test binary executables and scripts.

# Utilities

* base - configures and runs an Ardusimple SimpleRTK2B board as a fixed base.
* checksum - takes arguments that are NMEA or UBX packets and adds end matter.
* consumer - consumes datagrams and reports on stdout.
* gpstool - serves as Hazer's all purpose GNSS pocket tool.
* hazerclient - runs Google Maps API in Firefox browser under MacOS.
* hazer - consumes data from a serial port and reports on stdout.
* headless - uses inotifywait to watch headless output.
* pps - uses Diminuto pintool to multiplex on a 1PPS GPIO pin.
* producer - consumes data from serial port and forwards as datagrams.
* provider - consumes datagrams and forwards to serial port.
* proxy - receive UDP packets from the Base and forward to the Rover.
* rover - configures and runs an Ardusimple SimpleRTK2B board as a mobile rover.
* tumbleweed-forwarder - Handles forwarding of RTCM messages from base to rover.

# Functional Tests

* bu353s4 - exercises the GlobalSat BU-353S4 receiver.
* bu353w10 - exercises the GlobalSat BU-353W10 receiver.
* bu353w10F - exercises the GlobalSat BU-353W10 receiver with slow displays.
* bu353w10H - exercises the GlobalSat BU-353W10 receiver in headless mode.
* bu353w10M4 - exercises the GlobalSat BU-353W10 receiver logging PRN 4.
* bu353w10S - uses socat to send data from GlobalSat BU-353W10 to gpstool over named pipe.
* bu353W10X - exercises the GlobalSat BU-353W10 receiver while testing data expiration.
* gn803g - exercises the TOPGNSS GN-803G receiver.
* gr701w - exercises the NaviSys GR701W receiver.    
* simplertk2b - exercises the Ardusimple SimpleRTK2B board.
* simplertk2bbase - configures an Ardusimple SimpleRTK2B board as a base.
* simplertk2bquery - queries the configuration of an Ardusimple SimpleRTK2B board.
* simplertk2brover - configures an Ardusimple SimpleRTK2B board as a rover.
* sink - received forwarded UDP packets and display.
* sirfstar4 - exercises any SiRF Star 4 device.
* source - send UDP packets to the proxy to be forwarded.
* talkers - processes a file of synthetic input.
* ublox7 - exercises any Ublox 7 device.    
* ublox8 - exercises any Ublox 8 device.
* ublox9 - exercises any Ublox 9 device.
* ublox8debug - exercises any Ublox 8 device with gpstool debug enabled.
* uputronics - exercises the Uputronics GPS board for the Rasperry Pi.

# Help

    gpstool -?
    usage: gpstool [ -d ] [ -u ] [ -v ] [ -x ] [ -V ] [ -X ] [ -M PRN ] [ -D DEVICE [ -b BPS ] [ -7 | -8 ] [ -e | -o | -n ] [ -1 | -2 ] [ -l | -m ] [ -h ] [ -s ] | -S FILE ] [ -I PIN ] [ -c ] [ -p PIN ] [ -W STRING ... ] [ -U STRING ... ] [ -R | -E | -F | -H HEADLESS ] [ -A ADDRESS ] [ -P PORT ] [ -O ] [ -L LOG ] [ -t SECONDS ] [ -C ]
           -1          Use one stop bit for DEVICE.
           -2          Use two stop bits for DEVICE.
           -4          Use IPv4 for ADDRESS, PORT.
           -6          Use IPv6 for ADDRESS, PORT.
           -7          Use seven data bits for DEVICE.
           -8          Use eight data bits for DEVICE.
           -A ADDRESS  Send sentences to ADDRESS.
           -C          Ignore bad checksums.
           -D DEVICE   Use DEVICE for input or output.
           -E          Like -R but use ANSI escape sequences.
           -F          Like -E but refresh at 1Hz.
           -H HEADLESS Like -R but writes screen to HEADLESS file.
           -I PIN      Take 1PPS from GPIO input PIN (requires -D).
           -L LOG      Write sentences to LOG file.
           -O          Output sentences to DEVICE.
           -P PORT     Send to or receive from PORT.
           -R          Print a report on standard output.
           -S SOURCE   Use SOURCE file for input.
           -U STRING   Collapse STRING, append checksum, write to DEVICE, expect ACK.
           -U ''       Exit when this empty STRING is processed.
           -V          Print release, vintage, and revision on standard output.
           -W STRING   Collapse STRING, append checksum, write to DEVICE.
           -W ''       Exit when this empty STRING is processed.
           -X          Enable message expiration test mode.
           -b BPS      Use BPS bits per second for DEVICE.
           -c          Take 1PPS from DCD (requires -D and implies -m).
           -d          Display debug output on standard error.
           -e          Use even parity for DEVICE.
           -l          Use local control for DEVICE.
           -m          Use modem control for DEVICE.
           -o          Use odd parity for DEVICE.
           -p PIN      Assert GPIO output PIN with 1PPS (requires -D and -I or -c).
           -n          Use no parity for DEVICE.
           -h          Use RTS/CTS for DEVICE.
           -r          Reverse use of standard output and standard error.
           -s          Use XON/XOFF for DEVICE.
           -t SECONDS  Expire GNSS data after SECONDS seconds.
           -u          Note unknown NMEA or UBX on standard error.
           -v          Display verbose output on standard error.
 
# Display

When using the -E option with gpstool, so that it uses ASCII escape sequences
to do cursor control for its report on standard output, as this example does
when using Ublox 9-based receiver,

    > gpstool -D devttyACM0 -b 9600 -8 -n -1 -E -t 10

the display looks something like this snapshot as it is continually updated.

    INP [ 52] $GNGLL,3947.65220,N,10509.20236,W,194527.00,A,A*6B\r\n
    OUT [  0]
    LOC 2019-05-07T13:45:27.049-07:00+01T          0/00:00:00.895 18.0.0   nickel
    TIM 2019-05-07T19:45:27.000-00:00+00Z 0pps                             GNSS
    POS 39°47'39.13"N, 105°09'12.14"W    39.794203333, -105.153372666      GNSS
    ALT    5595.40'   1705.500m                                            GNSS
    COG N     0.000000000°T    0.000000000°M                               GNSS
    SOG       0.026mph       0.023000knots       0.042000kph               GNSS
    INT GLL [12] 1dmy 1inc (  9 10  5  0  0  4  4 )                        GNSS
    HPP   39.794203348, -105.153372746 ±     4.3267m                       GNSS
    HPA   1705.5121m ±     6.9854m                                         GNSS
    BAS 1active 0valid         17sec         17obs      27.0312m           RTCM
    ACT [1]  {    18    15    17    11     1    13 } [ 6] [10] [25]        GPS
    ACT [2]  {    30    28    19     6             } [ 4] [10] [25]        GPS
    ACT [1]  {    86    85    77    75    76    87 } [ 6] [ 6] [25]        GLONASS
    ACT [1]  {     1    15    21    27    26    13 } [ 6] [ 6] [25]        GALILEO
    ACT [1]  {    26    29    12                   } [ 3] [ 3] [25]        BEIDOU
    DOP   0.95pdop   0.55hdop   0.78vdop                                   GPS
    DOP   0.95pdop   0.55hdop   0.78vdop                                   GLONASS
    DOP   0.95pdop   0.55hdop   0.78vdop                                   GALILEO
    DOP   0.95pdop   0.55hdop   0.78vdop                                   BEIDOU
    SAT [  1]     1id  34°elv   61°azm   27dBHz  6sig <                    GPS
    SAT [  2]     6id  11°elv  183°azm   35dBHz  6sig <                    GPS
    SAT [  3]     7id   9°elv  147°azm   29dBHz  6sig                      GPS
    SAT [  4]    11id  26°elv   50°azm    0dBHz  6sig <   !                GPS
    SAT [  5]    13id  30°elv  254°azm    0dBHz  6sig <   !                GPS
    SAT [  6]    15id  16°elv  287°azm   21dBHz  6sig <                    GPS
    SAT [  7]    17id  75°elv  247°azm   34dBHz  6sig <                    GPS
    SAT [  8]    18id  15°elv   41°azm    0dBHz  6sig <   !                GPS
    SAT [  9]    19id  49°elv  232°azm    0dBHz  6sig <   !                GPS
    SAT [ 10]    22id   0°elv   78°azm    0dBHz  6sig     !                GPS
    SAT [ 11]    24id   6°elv  319°azm   18dBHz  6sig                      GPS
    SAT [ 12]    28id  65°elv   41°azm    0dBHz  6sig <   !                GPS
    SAT [ 13]    30id  41°elv  154°azm   36dBHz  6sig <                    GPS
    SAT [ 14]    67id   1°elv  283°azm    0dBHz  3sig     !                GLONASS
    SAT [ 15]    68id   4°elv  332°azm    0dBHz  3sig     !                GLONASS
    SAT [ 16]    75id  30°elv  119°azm   37dBHz  3sig <                    GLONASS
    SAT [ 17]    76id  70°elv   78°azm    0dBHz  3sig <   !                GLONASS
    SAT [ 18]    77id  33°elv  324°azm   21dBHz  3sig <                    GLONASS
    SAT [ 19]    85id  20°elv   31°azm   23dBHz  3sig <                    GLONASS
    SAT [ 20]    86id  77°elv   57°azm   26dBHz  3sig <                    GLONASS
    SAT [ 21]    87id  37°elv  202°azm   17dBHz  3sig <                    GLONASS
    SAT [ 22]     1id  43°elv  312°azm   32dBHz  2sig <                    GALILEO
    SAT [ 23]     4id   9°elv  280°azm    0dBHz  2sig     !                GALILEO
    SAT [ 24]     9id   1°elv  327°azm    0dBHz  2sig     !                GALILEO
    SAT [ 25]    13id  62°elv   82°azm    0dBHz  2sig <   !                GALILEO
    SAT [ 26]    14id  41°elv   55°azm   36dBHz  2sig                      GALILEO
    SAT [ 27]    15id  19°elv   40°azm   19dBHz  2sig <                    GALILEO
    SAT [ 28]    19id   3°elv  229°azm    0dBHz  2sig     !                GALILEO
    SAT [ 29]    21id  73°elv   68°azm   31dBHz  2sig <                    GALILEO
    SAT [ 30]    26id  45°elv  182°azm   35dBHz  2sig <                    GALILEO
    SAT [ 31]    27id  24°elv  110°azm   31dBHz  2sig <                    GALILEO
    SAT [ 32]    33id   0°elv  205°azm    0dBHz  2sig     !                GALILEO
    SAT [ 33]     6id   3°elv  334°azm    0dBHz  0sig     !                BEIDOU
    SAT [ 34]    12id  10°elv  219°azm    0dBHz  0sig <   !                BEIDOU
    SAT [ 35]    16id   1°elv  341°azm    0dBHz  0sig     !                BEIDOU
    SAT [ 36]    24id   2°elv  312°azm    0dBHz  0sig     !                BEIDOU
    SAT [ 37]    26id  49°elv  311°azm    0dBHz  0sig <   !                BEIDOU
    SAT [ 38]    29id  61°elv   53°azm    0dBHz  0sig <   !                BEIDOU
    SAT [ 39]    30id   9°elv   45°azm    0dBHz  0sig     !                BEIDOU

INP is the most recent data read from the device, either NMEA sentences or
UBX packets, with binary data converted into standard C escape sequences.

OUT is the most recent data written to the device, as specified on the command
line using the -W (NMEA sentence) or -U (UBX message)  options.

MON displays some of the results received in the UBX-MON-HW message if enabled.
Ublox 8 chips with firmware revision 18 and above can provide clues to jamming
based on the received signal strength. (N.B. I don't have a way to test this.)
This requires that the jamming/interference monitor (ITFM) be calibrated using
the UBX-CFG-ITFM message.

STA displays some of the results received in the UBX-NAV-STATUS message if
enabled. Ublox 8 chips with firmware revision 18 and above can provide clues
to spoofing based on comparing navigation solutions from multiple GNSSes if
available. (N.B. I don't have a way to test this.) Also shown are the
milliseconds since first fix and milliseconds uptime provided by the message.

LOC is the current local time provided by the host system, the elapsed
time to first fix, the software release number, and the local host name.
The local time, with a fractional part in milliseconds, includes the time
zone offset from UTC in hours and minutes, the current daylight saving
time (DST) offset in hours, and the military time zone letter. If the
time zone offset is an even number of hours (some aren't: Newfie Time,
I'm looking at you), it will be a letter like "T" ("Tango") for Mountain
Standard Time as found in Denver; otherwise it will be "J" ("Juliet")
to indicate any local time zone.

All subsequent lines represent the current state of Hazer data structures
updated by data read from the device. Each line includes at its end the system
(satellite constellation) with which it is associated. GNSS indicates that the
device is computing an "ensemble" solution that uses transmissions from multiple
constellations, for example, from both the U.S. GPS constellation and the
Russian GLONASS constellation.

TIM is the most recent time solution, in UTC (or 'Z' for "Zulu"), and the
current value of the One Pulse Per Second (1PPS) signal if the device provides
it and it was enabled on the command line using -c (using data carrier detect
or DCD) or -I (using general purpose input/output or GPIO).

POS is the most recent position solution, latitude and longitude, in degrees,
hours, minutes, and decimal seconds, and in decimal degrees. Either format
can be cut and pasted directly into Google Maps, and at least the latter
into Google Earth.

N.B. The underlying position data is stored as binary integers in billionths
of a degree (nanodegrees). But the device under test may not provide that much
accuracy; the actual number of significant digits for various data is reported
by the INT line (below), but even this may be optimistic - or, for that matter,
pessimistic - when compared to what the device is capable of. In particular,
technologies like Wide Area Augmentation System (WAAS), multi-band GNSS,
differential GPS, Real-Time Kinematics (RTK), and long-term surveying, can
potentially achieve remarkable accuracy.

ALT is the most recent altitude solution, in feet and meters. (Similar comments
here regarding precision as those for POS.)

COG is the most recent course over ground solution, in cardinal compass
direction, and the bearing in degrees true, and degrees magnetic (if available).
(Similar comments here regarding precision as those for POS.)

SOG is the most recent speed over ground solution, in miles per hour, knots
(nautical miles per hour), and kilometers per hour. (Similar comments here
regarding precision as those for POS.)

INT is internal Hazer state including the name of the sentence (GLL in the
example above) that most recently updated the solution, the total number of
satellites that contributed to that solution, an indication as to whether the
day-month-year value has been set (only occurs once the RMC sentence has been
received), an indication as to whether time is incrementing monotonically (it
can appear to run backwards when receiving UDP packets because UDP may reorder
them), and some metrics as to the number of significant digits provided for
various datums provided by the device.

HPP and HPA (if present and enabled) show the high precision position and
altitude available from some Ublox devices, along with their estimated
accuracy. This may differ (slightly) from the position and altitude
reported via POS and ALT due to the conversion of units done to conform
to the NMEA format. When available, the HPP and HPA is expected to be
more precise.

BAS or ROV (if present and enabled) show information about the Ublox
device operating in base station or in rover modes. In base (stationary)
mode, it shows if the device is actively surveying or if the survey has
resolved to a valid location, how many seconds and observations have
been consumed during the survey, and what the mean error is. In rover
(mobile) mode, it shows what RTCM message was last received and from whom.

ACT is the list of active satellites, typically provided seperately
for each system or constellation by the device, showing each satellites
identifying number (for GPS, this is its pseudo-random noise or PRN code
number, but other systems using other conventions), and the number of
active satellites in this list, the number of active satellites for this
constellation, and the number of active satellites total.  Unlike the
other report lines, the system or constellation to which the data applies
is derived from (in order, depending on availability) the system id in the
GSA sentence (only available on devices that support later NMEA versions),
or an analysis of the Space Vehicle Identifier based on NMEA conventions,
or the talker specified at the beginning of the sentence. The reason
for this is that some devices (I'm looking at you, GN803G), specify
GNSS as the talker for all GSA sentences when they are computing an
ensemble solution (one based on multiple constellations); this causes
ambiguity between this case and the case of successive GSA sentences in
which the active satellite list has changed. Hazer independently tries
to determine the constellation to which the GSA sentence refers when
the talker is GNSS.

DOP is the position, horizontal, and vertical dilution of precision -
measures of the quality of the position fix (smaller is better) - based on
the real-time geometry of the satellites upon which the current solution
is based. If multiple constellations are reported, but the DOPs are all
the same, the device is typically computing an ensemble solution using
multiple constellations.

SAT is the list of satellites in view, including an index that is
purely an artifact of Hazer, the Space Vehicle IDentifier (specific to
the constellation), its elevation and azimuth in degrees based on its
ephemeris, the signal strength (really, a carrier to noise density ratio)
in deciBels Hertz of its transmission, a signal identifier indicating
which signal or band (e.g.  L1 C/A, L2, etc.) is being used, and one
or more flags. A flag of '<' indicates that the satellite is on the
active list (see ACT above), a '?' indicates that the azimuth and/or the
elevation were empty but display as zero (likely that the satellite is
not in the transmitted almanac), and an '!' indicates that the signal
strength was empty but displays as zero (some receivers use this to
indicate the satellite is not being tracked).

While NMEA (and UBX too for that matter) is good about updating the
application with new information, it is not so good about letting the
application know when that data is no longer relevant. For that reason,
all of the data read from the GPS devices has associated with it an
expiration time in seconds. This can be set from the command line, in
the range 0 to the default of 255. If the data is not updated within
that duration by new sentences or messages from the GPS device, it is
no longer displayed.

# Notes

N.B. Most of the snapshots below were taken from earlier versions of Hazer and
its gpstool utility. The snapshots were cut and pasted from actual output and
may differ slightly (or greatly) from that of the most current version. For
some of these, a \* was used to mean the degree symbol; later versions of
Hazer display the actual degree symbol using Unicode.

## Sending Commands

gpstool can send initialization commands to the GPS device. These can be either
NMEA sentences (without escape sequences) or binary UBX sentence (with
escape sequences). In either case, gpstool will automatically append the
appropriate ending sequences including a computed NMEA or UBX checksum.
Here is an example of gpstool writing proprietary NMEA and binary UBX sequences
to a NaviSys GR-701W which has a UBlox 7 chipset.

    > gpstool -D /dev/ttyUSB0 -b 9600 -8 -n -1 -c -E \
          -W "\$PUBX,00" \
          -W "\$PUBX,03" \
          -W "\$PUBX,04" \
          -W "\\xb5\\x62\\x06\\x01\\x08\\x00\\x02\\x13\\x00\\x01\\x00\\x00\\x00\\x00" \
          -W "\\xb5\\x62\\x0a\\x04\\x00\\x00" \
          -W "\\xb5\\x62\\x06\\x31\\x00\\x00" \
          -W "\\xb5\\x62\\x06\\x3e\\x00\\x00" \
          -W "\\xb5\\x62\\x06\\x06\\x00\\x00"

(The code to write commands to the device depends on being driven by incoming
data from the device, so if the device is initially silent, this won't work.
All the GPS receivers I've tested are chatty by default, so this hasn't been an
issue for me.)

If a written command is of zero length (really: has a NUL or \0 character as its
first character), gpstool exits. This can be used by a script, for example, to
use gpstool to send a command to change the baud rate of the GPS device serial
port and exit, and then start a new gpstool with the new baud rate.

## Forwarding Datagrams

Here is an example of using gpstool to read an NMEA sentence stream from a
serial device at 115200 8n1, display the data using ANSI escape sequences to
control the output terminal, and forwards NMEA sentences to a remote
instance of itself listing on port 5555 on host "lead".

    > gpstool -D /dev/ttyUSB0 -b 115200 -8 -n -1 -E -6 -A lead -P 5555
    
    $GPRMC,164659.00,A,3947.65335,N,10509.20343,W,0.063,,310718,,,D*63\r\n
    MAP 2018-07-31T16:46:59Z 39*47'39.20"N,105*09'12.20"W  5631.82' N     0.072mph PPS 1
    RMC 39.794222,-105.153391  1716.600m   0.000*    0.063knots [10] 9 10 5 0 4
    GSA {  51   6  12  48  28  19   2  24   3  17 } [10] pdop 1.70 hdop 0.86 vdop 1.47
    GSV [01] sat   2 elv 28 azm 206 snr 40dBHz con GPS
    GSV [02] sat   3 elv 14 azm  59 snr 27dBHz con GPS
    GSV [03] sat   6 elv 67 azm 166 snr 37dBHz con GPS
    GSV [04] sat  12 elv 23 azm 308 snr 33dBHz con GPS
    GSV [05] sat  17 elv 54 azm  44 snr 17dBHz con GPS
    GSV [06] sat  19 elv 72 azm 352 snr 31dBHz con GPS
    GSV [07] sat  22 elv  5 azm  39 snr 21dBHz con GPS
    GSV [08] sat  24 elv 40 azm 287 snr 18dBHz con GPS
    GSV [09] sat  28 elv 30 azm 112 snr 32dBHz con GPS
    GSV [10] sat  46 elv 38 azm 215 snr 34dBHz con GPS
    GSV [11] sat  48 elv 36 azm 220 snr 39dBHz con GPS
    GSV [12] sat  51 elv 44 azm 183 snr 43dBHz con GPS

## Receiving Datagrams

Here is the remote instance of gpstool receiving the NMEA stream via
the UDP socket on port 5555.

    > gpstool -6 -P 5555 -E

    $GPGLL,3947.65274,N,10509.20212,W,164744.00,A,D*7F\r\n
    MAP 2018-07-31T16:47:44Z 39*47'39.16"N,105*09'12.12"W  5612.79' N     0.048mph PPS 0
    GGA 39.794212,-105.153369  1710.800m   0.000*    0.042knots [10] 9 10 5 0 4
    GSA {  51   6  12  48  28  19   2  24   3  17 } [10] pdop 1.71 hdop 0.86 vdop 1.48
    GSV [01] sat   2 elv 28 azm 206 snr 38dBHz con GPS
    GSV [02] sat   3 elv 14 azm  58 snr 26dBHz con GPS
    GSV [03] sat   6 elv 67 azm 165 snr 38dBHz con GPS
    GSV [04] sat  12 elv 24 azm 308 snr 33dBHz con GPS
    GSV [05] sat  17 elv 54 azm  44 snr 21dBHz con GPS
    GSV [06] sat  19 elv 72 azm 353 snr 33dBHz con GPS
    GSV [07] sat  22 elv  5 azm  39 snr 18dBHz con GPS
    GSV [08] sat  24 elv 41 azm 287 snr 19dBHz con GPS
    GSV [09] sat  28 elv 29 azm 112 snr 29dBHz con GPS
    GSV [10] sat  46 elv 38 azm 215 snr 34dBHz con GPS
    GSV [11] sat  48 elv 36 azm 220 snr 39dBHz con GPS
    GSV [12] sat  51 elv 44 azm 183 snr 42dBHz con GPS

## Using screen

You can use the screen utility, available for MacOS and Linux/GNU, to capture
the NMEA stream on a serial port. (And on Windows systems, I use PuTTY.)

    > screen /dev/cu.usbserial-FT8WG16Y 9600 8n1

    $GPRMC,190019.00,A,3947.65139,N,10509.20196,W,0.053,,060818,,,D*66
    $GPVTG,,T,,M,0.053,N,0.099,K,D*20
    $GPGGA,190019.00,3947.65139,N,10509.20196,W,2,10,1.05,1707.9,M,-21.5,M,,0000*5B
    $GPGSA,A,3,06,19,24,51,02,12,48,29,25,05,,,1.75,1.05,1.40*08
    $GPGSV,4,1,14,02,77,008,30,05,42,164,48,06,32,051,20,09,03,060,*71
    $GPGSV,4,2,14,12,73,214,28,17,04,101,13,19,24,092,20,24,06,217,31*71
    $GPGSV,4,3,14,25,45,305,29,29,17,294,11,31,03,327,08,46,38,215,30*71
    $GPGSV,4,4,14,48,36,220,32,51,44,183,42*7C
    $GPGLL,3947.65139,N,10509.20196,W,190019.00,A,D*7E
    $GPRMC,190020.00,A,3947.65143,N,10509.20192,W,0.044,,060818,,,D*63
    $GPVTG,,T,,M,0.044,N,0.081,K,D*2F
    $GPGGA,190020.00,3947.65143,N,10509.20192,W,2,09,1.05,1707.9,M,-21.5,M,,0000*50
    $GPGSA,A,3,06,19,24,51,02,12,48,25,05,,,,1.75,1.05,1.40*03
    $GPGSV,4,1,14,02,77,008,31,05,42,164,48,06,32,051,21,09,03,060,23*70
    $GPGSV,4,2,14,12,73,214,29,17,04,101,12,19,24,092,19,24,06,217,31*7B
    $GPGSV,4,3,14,25,45,305,29,29,17,294,09,31,03,327,06,46,38,215,31*77
    $GPGSV,4,4,14,48,36,220,32,51,44,183,43*7D
    $GPGLL,3947.65143,N,10509.20192,W,190020.00,A,D*7D
    $GPRMC,190021.00,A,3947.65143,N,10509.20191,W,0.050,,060818,,,D*64
    $GPVTG,,T,,M,0.050,N,0.092,K,D*28
    $GPGGA,190021.00,3947.65143,N,10509.20191,W,2,10,1.05,1708.0,M,-21.5,M,,0000*5C

## Using gpsd

You can test GPS devices independently of this software using the
excellent Linux open source GPS stack. Here is just a simple example of
stopping the GPS daemon if it has already been started (make sure you
are not going to break something doing this), restarting it in non-deamon
debug mode, and running a client against it. In this example, I use the
Garmin GLO Bluetooth device I have already set up, and the X11 GPS client.
When I'm done, I restart gpsd in normal daemon mode.

    > sudo service gpsd stop
    > gpsd -N /dev/rfcomm0 &
    > xgps
    ...
    > kill %+
    > sudo service start gpsd

## Using socat

You can use the socat utility, available for Linux/GNU and MacOS flavored
systems, to capture the NMEA stream on the UDP port.

    > socat UDP6-RECVFROM:5555,reuseaddr,fork STDOUT

    $GPGSA,M,3,32,10,14,18,31,11,24,08,21,27,01,,1.3,0.8,1.1*33
    $GPGSV,3,1,12,32,79,305,39,10,66,062,41,14,58,247,35,18,40,095,34*72
    $GPGSV,3,2,12,31,21,180,45,11,20,309,27,24,19,044,30,08,17,271,31*7A
    $GPGSV,3,3,12,21,13,156,39,27,13,233,33,01,09,320,20,51,43,183,42*72

You may be tempted (I was) to dispense with gpstool entirely and use
socat to forward NMEA strings to a remote site.  Be aware that when
used in UDP consumer mode, gpstool expects every UDP datagram to be
a fully formed NMEA sentence, because that's how it sends them in UDP
producer mode. socat isn't so polite. Since the occasional UDP packet
will inevitably be lost, if the output of socat is piped into gpstool,
it will see a lot of corruption in the input stream. Using gpstool on
both ends means only entire NMEA sentences are lost, and gpstool can
recover from this.

    > socat OPEN:/dev/ttyUSB0,b115200 UDP6-SENDTO:[::1]:5555

The RMC and GGA sentences contain UTC timestamps (and the RMC contains
a DMY datestamp). Hazer rejects sentences for which time runs backwards.
Although this should be impossible for the sentences in the stream from
a GPS device, it is entirely possible for the UDP stream from a Hazer
producer, since UDP packet ordering is not guaranteed.

You might be tempted to use TCP instead of UDP. That sounds like a good
idea: guaranteed delivery, packets always in order. However, this can
introduce a lot of lantency in the NMEA stream. The result is the NMEA
stream received by the consumer may lag signficantly behind real-time,
and that lag increases the longer the system runs. So over time it
diverges more and more with reality.  It is better to lose an NMEA
sentence than have it delayed. After all, another more up-to-date sentence
is on the way right behind it.

## Using Bluetooth

You can use gpstool with Bluetooth GPS units like the Garmin GLO.

    > sudo bluetoothctl
    power on
    agent on
    scan on
    ...
    scan off
    pair 01:23:45:67:89:AB
    quit
    > sudo rfcomm bind 0 01:23:45:67:89:AB 1
    > sudo chmod 666 /dev/rfcomm0
    > gpstool -D /dev/rfcomm0 -E

    $GPVTG,350.4,T,341.6,M,000.08,N,0000.15,K,D*18\r\n
    MAP 2017-09-14T14:22:05Z 39*47'39.20"N,105*09'12.13"W  5613.45' N     0.092mph
    GGA 39.794223,-105.153371  1711.000m 350.400*    0.080knots [12] 10 11 5 4 5
    GSA {  30  28  84   2  19   6  91  24  12  22  72   3 } [12] pdop 1.20 hdop 0.70 vdop 1.00
    GSV [01] sat  51 elv 43 azm 182 snr 45dBHz con GPS
    GSV [02] sat  30 elv  4 azm 161 snr 31dBHz con GPS
    GSV [03] sat  28 elv 35 azm 105 snr 22dBHz con GPS
    GSV [04] sat  84 elv 45 azm 245 snr 37dBHz con GPS
    GSV [05] sat   2 elv 21 azm 204 snr 36dBHz con GPS
    GSV [06] sat  19 elv 74 azm 346 snr 42dBHz con GPS
    GSV [07] sat   6 elv 56 azm 175 snr 45dBHz con GPS
    GSV [08] sat  91 elv 66 azm   5 snr 25dBHz con GPS
    GSV [09] sat  24 elv 36 azm 301 snr 26dBHz con GPS
    GSV [10] sat  12 elv 13 azm 304 snr 32dBHz con GPS
    GSV [11] sat  22 elv  7 azm  46 snr 24dBHz con GPS
    GSV [12] sat  72 elv 39 azm 326 snr 30dBHz con GPS
    GSV [13] sat   3 elv 14 azm  67 snr 27dBHz con GPS

    > sudo rfcomm release 0
    > sudo bluetoothctl
    power off
    quit

## Using One Pulse Per Second

Some GPS devices provide a 1Hz One Pulse Per Second (1PPS) signal that is, if
implemented correctly, closely phase locked to GPS time. Hazer and its
gpstool utility are user-space software running on a non-real-time operating
system, so any periodic action by Hazer is at best approximate in terms of
period. But handling 1PPS even with some jitter is useful for casual testing
of GPS devices.

You can test GPS devices like the NaviSys GR-701W that provide 1PPS by toggling
the Data Carrier Detect (DCD) modem control line. This includes devices that
have a USB serial interface. Note the addition of the -c flag.

    > gpstool -D /dev/ttyUSB0 -b 9600 -8 -n -1 -E -c
    
    $GPRMC,174227.00,A,3947.65321,N,10509.20367,W,0.027,,040518,,,D*68\r\n
    MAP 2018-05-04T17:42:27Z 39*47'39.19"N,105*09'12.22"W  5600.00' N     0.031mph 1PPS
    RMC 39.794220,-105.153395  1706.900m   0.000*    0.027knots [10] 9 10 5 0 4
    GSA {   9   7   8  30  51  27  23  48  28  11 } [10] pdop 2.13 hdop 1.01 vdop 1.88
    GSV [01] sat   5 elv 10 azm 297 snr 22dBHz con GPS
    GSV [02] sat   7 elv 72 azm 348 snr 31dBHz con GPS
    GSV [03] sat   8 elv 56 azm  92 snr 23dBHz con GPS
    GSV [04] sat   9 elv 52 azm 187 snr 36dBHz con GPS
    GSV [05] sat  11 elv 18 azm 143 snr 34dBHz con GPS
    GSV [06] sat  16 elv  1 azm  55 snr  0dBHz con GPS
    GSV [07] sat  18 elv  4 azm 125 snr 27dBHz con GPS
    GSV [08] sat  23 elv 18 azm 161 snr 43dBHz con GPS
    GSV [09] sat  27 elv 29 azm  48 snr 31dBHz con GPS
    GSV [10] sat  28 elv 35 azm 246 snr 32dBHz con GPS
    GSV [11] sat  30 elv 48 azm 307 snr 35dBHz con GPS
    GSV [12] sat  46 elv 38 azm 215 snr 43dBHz con GPS
    GSV [13] sat  48 elv 36 azm 220 snr 42dBHz con GPS
    GSV [14] sat  51 elv 44 azm 183 snr 37dBHz con GPS

You can also test GPS devices like the MakerFocus USB-Port-GPS that provide
1PPS by toggling a General Purpose I/O (GPIO) pin. This example (which I've run
on a Raspberry Pi) uses pin 18. Note the addition of the -I flag. (You may have
to run gpstool as root to access the GPIO pins.)

    # gpstool -D /dev/ttyUSB1 -b 9600 -8 -n -1 -I 18 -E
    
    $GPGSV,3,1,11,23,85,357,39,16,62,069,40,09,45,311,37,51,43,183,43*75\r\n
    MAP 2018-05-08T14:50:25Z 39*47'39.17"N,105*09'12.19"W  5588.51' N     0.000mph
    GGA 39.794215,-105.153387  1703.400m   0.000*    0.000knots [09] 8 9 5 3 3
    GSA {   8   7  22  26  23   9   3  16  27 } [09] pdop 1.94 hdop 1.03 vdop 1.64
    GSV [01] sat  23 elv 85 azm 357 snr 39dBHz con GPS
    GSV [02] sat  16 elv 62 azm  69 snr 40dBHz con GPS
    GSV [03] sat   9 elv 45 azm 311 snr 37dBHz con GPS
    GSV [04] sat  51 elv 43 azm 183 snr 44dBHz con GPS
    GSV [05] sat  26 elv 34 azm  48 snr 28dBHz con GPS
    GSV [06] sat   3 elv 33 azm 200 snr 44dBHz con GPS
    GSV [07] sat   7 elv 23 azm 268 snr 28dBHz con GPS
    GSV [08] sat  27 elv 20 azm 126 snr 36dBHz con GPS
    GSV [09] sat  22 elv 16 azm 183 snr 42dBHz con GPS
    GSV [10] sat   8 elv  5 azm 160 snr 34dBHz con GPS
    GSV [11] sat  31 elv  2 azm  73 snr  0dBHz con GPS

gpstool can assert an output GPIO pin in approximate syntonization with the
1PPS signal derived from either DCD or GPIO. This example (which I've run on a
Raspberry Pi with the GR-701W) uses pin 16. Note the addition of the -p flag.
(Again, you may have to run gpstool as root to access the GPIO pins.)

    # gpstool -D /dev/ttyUSB0 -b 9600 -8 -n -1 -E -c -p 16

The GPIO functions implemented in Diminuto and used by gpstool may get confused
if gpstool exits ungracefully leaving GPIO pins configured. If necessary, you
can deconfigure GPIO pins using the Diminuto pintool utility

    # pintool -p 18 -n
    # pintool -p 16 -n

## True Versus Magnetic Bearings

GPS devices compute the true bearing by comparing successive position fixes to
determine your speed and direction. Hence, the true bearing, e.g. "135.000\*T",
is only reliable if you are moving, and at a speed fast enough to be within
the resolution of the accuracy of the position fix. The magnetic bearing is an
actual magnetic compass bearing, but is only provided by GPS devices which also
have a magnetic compass; otherwise it will be displayed as "0.000\*M". The
cardinal compass direction, e.g. "SE", is based on the true bearing.

## Google Earth Pro

In February 2017 I used Hazer with Google Earth Pro, the desktop version of the
web based application. Today, August 2018, the real-time GPS feature of Google
Earth Pro no longer seems to work with latest version, 7.3.2, for the Mac (I
haven't tried it for other operating systems). Neither does 7.3.1. But 7.1.8
works.

Google Earth Pro only accepts GPS data on a serial port, or at least something
that kinda sorta looks like a serial port. I've used a FIFO (named pipe), via
the mkfifo(1) command, for stuff like this in the past, but there doesn't seem
to be any way to get Pro to recognize the FIFO; only serial(ish) devices may
apply here.

So I processed the NMEA stream from a serial-attached GPS device using gpstool
running on a Raspberry Pi, then forwarded it via UDP datagrams to another
gpstool on the Raspberry Pi. (This is the bin/producer.sh script.)

    gpstool -D /dev/ttyUSB0 -b 4800 -8 -n -1 -6 -c -A ip6-localhost -P 5555 -E

Then I used the second gpstool to forward the NMEA stream out a serial port
across a two FTDI USB-to-serial adaptors hooked back-to-back with a null
modem in between, to a Mac running Google Earth Pro. (This is the
bin/provider.sh script.)

    gpstool -6 -P 5555 -O -D /dev/ttyUSB1 -b 4800 -8 -n -1

I used the "GPS Import Realtime" drop down menu in Google Earth Pro to select
the USB serial device representing the other end of the FTDI "milking
machine". The menu liked the device "/dev/cu.usbserial-XXXXXXXX" where the Xs
are some kind of internal identifier on MacOS where Pro was running. 

Empirically, and according to a Google search, anecdotally, but undocumentedly,
Google Earth Pro appears to only accept serial input at 4800 baud. More recent
and advanced GPS devices default to 9600 baud, and can overrun a 4800 baud
serial port. So I used a USGlobalSat BU-353S4, which defaults to 4800 baud, as
my GPS device on the Linux server.

As Rube Goldberg as this is, it seems to work.

## NMEA TXT Sentences

Some devices are chatty and emit interesting and sometimes useful information
as NMEA TXT sentences. These can be recognized by Hazer and logged to standard
error by gpstool. Some of the functional tests save standard error output in
log files under the build artifact directory, or redirected to the system log
using the Diminuto log command as shown below.

    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "u-blox AG - www.u-blox.com".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "HW UBX-M8030 00080000".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "ROM CORE 3.01 (107888)".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "FWVER=SPG 3.01".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "PROTVER=18.00".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "GPS;GLO;GAL;BDS".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "SBAS;IMES;QZSS".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "GNSS OTP=GPS;GLO".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "LLC=FFFFFFFF-FFFF7CBF-FFED7FAA-FFFFFFFF-FFFFFFF9".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "ANTSUPERV=AC SD PDoS SR".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "ANTSTATUS=OK".
    Nov 30 08:36:31 nickel bu353w10F[8836]: gpstool: TXT [ 1][ 1][ 2] "PF=3FF".

## Phantom GPS Satellite PRN 4

Around 2018-11-29T12:00-07:00, I was testing some changes to Hazer with
the Ublox-8 based BU353W10 receiver by comparing its results to those
of the web site <https://in-the-sky.org/satmap_radar.php> that presents
a real-time sky map of the visible orbiting space vehicles (not just
GPS). I noticed that my BU353W10 was reporting GPS PRN 4 as "in view"
with a zero elevation and zero azimuth; that vehicle wasn't reported by
the sky map. Worse: a little web-search-fu told me that there was no PRN
4; it does not appear in the most recent GPS almanac. The GPS vehicle
using PRN 4 was decommisioned and its pseudo-random number code has
not yet been reused.

Before I could do much else, PRN 4 dropped from view.

PRN 4 reappeared the next morning around 2018-11-30T09:00-07:00. I
quickly dumped the raw NMEA and verified using NMEA 0183 Version 4.10
pp. 96-97 that I wasn't decoding the GSV sentence incorrectly.

    $GPGSV,4,1,15,04,,,36,05,04,062,22,10,27,253,32,13,32,053,38*43\r\n
    $GPGSV,4,2,15,15,60,092,39,16,15,289,26,20,53,269,,21,72,336,22*75\r\n
    $GPGSV,4,3,15,24,06,129,33,26,10,264,15,27,11,322,31,29,36,170,50*78\r\n
    $GPGSV,4,4,15,46,38,215,45,48,36,220,43,51,44,183,44*43\r\n

However, I noticed that the elevation and azimuth for PRN 4 weren't actually
zero: they were empty strings, although the SNR was a reasonable (and changing
over time) value. I coded up a change to Hazer to detect this and mark it, and
to gpstool to display a '?' next to that SAT entry. I was able to test this
before PRN 4 again dropped from view.

PRN 4 reappeared about twenty minutes later.

    SAT [  1]     4:   0*elv    0*azm   33dBHz   ?                         GPS
    SAT [  2]     8:   3*elv  328*azm    0dBHz                             GPS
    SAT [  3]    10:  43*elv  273*azm   35dBHz <                           GPS
    SAT [  4]    13:  16*elv   41*azm    0dBHz                             GPS
    SAT [  5]    15:  48*elv   58*azm   37dBHz <                           GPS
    SAT [  6]    16:   6*elv  270*azm   26dBHz <                           GPS
    SAT [  7]    20:  67*elv  305*azm   35dBHz <                           GPS
    SAT [  8]    21:  82*elv   82*azm   27dBHz <                           GPS
    SAT [  9]    24:  20*elv  112*azm   30dBHz <                           GPS
    SAT [ 10]    27:  28*elv  311*azm   35dBHz <                           GPS
    SAT [ 11]    29:  14*elv  171*azm   46dBHz <                           GPS
    SAT [ 12]    32:  12*elv  207*azm   41dBHz <                           GPS
    SAT [ 13]    46:  38*elv  215*azm   45dBHz                             GPS
    SAT [ 14]    48:  36*elv  220*azm   44dBHz <                           GPS
    SAT [ 15]    51:  44*elv  183*azm   45dBHz <                           GPS
    SAT [ 16]    68:  19*elv   41*azm   27dBHz <                           GLONASS
    SAT [ 17]    69:  66*elv    6*azm   33dBHz <                           GLONASS
    SAT [ 18]    70:  42*elv  246*azm   18dBHz <                           GLONASS
    SAT [ 19]    77:   2*elv   15*azm   22dBHz                             GLONASS
    SAT [ 20]    78:   3*elv   60*azm   18dBHz                             GLONASS
    SAT [ 21]    83:  20*elv  152*azm   35dBHz <                           GLONASS
    SAT [ 22]    84:  78*elv  169*azm   30dBHz <                           GLONASS
    SAT [ 23]    85:  40*elv  326*azm   28dBHz <                           GLONASS
    SAT [ 24]    89:  67*elv    6*azm    0dBHz                             GLONASS

It continued to drop from view and reappear. Its period of appearance does
not coincide with the GPS orbital period.

Neither NMEA 0183 4.10 nor Ublox 8 R15 suggests any interpretation of the
empty elevation and azimuth fields. As always, I'm assuming this somehow is
a bug in my code. But it does occur to me that PRN 4 would be useful for
testing a ground-based GPS transmitter; the period of its appearance would
make sense for a transmitter in the continental America time zones.

Checking the FAA Notice To Airmen (NOTAM) notifications on the web, there are
GPS disruptions scheduled for the late November/early December time frame,
centered on the White Sands Missle Range (WSMR) in New Mexico, and the Yuma
Proving Grounds (YPG) in Arizona, either of which is potentially within
range of my location in Denver Colorado. So this could be the U.S. military
doing testing.

I temporarily added code to gpstool to monitor the comings and goings
of GPS PRN 4 and remark upon them in the system log. Here's an example
of what those log messages look like during an actual run of just a
few hours. '#' is the initial state value when gpstool starts running,
'?' means GPS PRN 4 came into view, and ' ' means it exited from view. The
log also includes the initial and maximum signal strength, and the
transmission duration in milliseconds.  All clock times are in MST.

Here is the log for a twenty-four hour period.

    Dec  3 09:32:06 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '#' now '?' at 25dBHz
    Dec  3 09:42:03 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 38dBHz for 597010ms
    Dec  3 09:48:59 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 34dBHz
    Dec  3 09:58:51 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 592009ms
    Dec  3 10:01:11 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 35dBHz
    Dec  3 10:29:57 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 40dBHz for 1726038ms
    Dec  3 10:30:11 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 38dBHz
    Dec  3 10:32:34 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 39dBHz for 143006ms
    Dec  3 10:33:14 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 35dBHz
    Dec  3 10:34:27 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 40dBHz for 72998ms
    Dec  3 10:34:50 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 33dBHz
    Dec  3 10:35:38 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 37dBHz for 48001ms
    Dec  3 10:35:50 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 37dBHz
    Dec  3 11:37:43 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 43dBHz for 3713086ms
    Dec  3 11:42:22 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 29dBHz
    Dec  3 11:49:29 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 427014ms
    Dec  3 11:59:15 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 25dBHz
    Dec  3 11:59:16 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 25dBHz for 999ms
    Dec  3 13:35:06 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 23dBHz
    Dec  3 13:35:07 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 23dBHz for 998ms
    Dec  3 16:37:48 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 31dBHz
    Dec  3 16:45:52 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 484015ms
    Dec  3 17:08:03 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 29dBHz
    Dec  3 17:11:16 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 193003ms
    Dec  3 17:14:37 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 30dBHz
    Dec  3 17:19:16 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 34dBHz for 279011ms
    Dec  3 17:26:53 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 31dBHz
    Dec  3 17:41:51 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 898023ms
    Dec  3 18:00:33 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 30dBHz
    Dec  3 18:06:14 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 341011ms
    Dec  3 18:09:17 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 33dBHz
    Dec  3 18:22:07 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 37dBHz for 770011ms
    Dec  3 18:26:10 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 34dBHz
    Dec  3 18:59:11 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 39dBHz for 1981048ms
    Dec  3 19:00:54 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 33dBHz
    Dec  3 19:30:34 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 38dBHz for 1780046ms
    Dec  3 19:33:50 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 31dBHz
    Dec  3 19:44:47 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 36dBHz for 657014ms
    Dec  3 19:55:24 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 27dBHz
    Dec  3 20:02:55 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 33dBHz for 451009ms
    Dec  4 05:52:37 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 26dBHz
    Dec  4 05:52:39 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 26dBHz for 2001ms
    Dec  4 05:52:40 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 26dBHz
    Dec  4 05:52:41 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 26dBHz for 1007ms
    Dec  4 08:10:39 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 31dBHz
    Dec  4 08:16:56 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 33dBHz for 377014ms
    Dec  4 08:19:21 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 29dBHz
    Dec  4 08:22:17 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 31dBHz for 176011ms
    Dec  4 08:28:52 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 32dBHz
    Dec  4 08:40:15 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 34dBHz for 683019ms
    Dec  4 09:03:34 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 33dBHz
    Dec  4 09:17:36 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 38dBHz for 842031ms
    Dec  4 09:22:47 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was ' ' now '?' at 35dBHz
    Dec  4 09:39:55 nickel gpstool[20052]: gpstool: phantom GPS PRN 4 was '?' now ' ' at 35dBHz for 1027038ms

The durations in this sample last for anywhere from a second to half an hour.
During this period the transmissions ceased at 20:00MST and resumed at 06:00MST.
This seems correlated with typical "working hours" in the U.S. continental
time zones.

On 2018-12-04, the U. S. Coast Guard straightened me out.

    *** GENERAL MESSAGE TO ALL GPS USERS ***
    ON APPROXIMATELY 10 OCT 2018 SVN36 WILL RESUME TRANSMITTING L-BAND
    UTILIZING PRN04. AT L-BAND ACTIVATION, SVN36/PRN04 WILL BE UNUSABLE
    UNTIL FURTHER NOTICE.  ADDITIONALLY, NO BROADCAST ALMANACS WILL
    INCLUDE SVN36/PRN04 UNTIL FURTHER NOTICE.
    *** GENERAL MESSAGE TO ALL GPS USERS ***

On 2018-12-23, the first of the next generation Block IIIA GPS satellites
was launched.

    *** GENERAL MESSAGE TO ALL GPS USERS ***
    GPS III SVN74 (PRN04) WAS LAUNCHED ON 23 DEC 2018 (2018 JDAY 357)
    AT 1351 ZULU. THIS SATELLITE WILL UNDERGO EXTENSIVE ON-ORBIT CHECK
    OUT AND TESTING PRIOR TO BEING SET HEALTHY.  A USABINIT NANU WILL
    BE SENT WHEN THE SATELLITE IS SET ACTIVE TO SERVICE.
    *** GENERAL MESSAGE TO ALL GPS USERS ***

Note that the new satellite uses PRN 4. I suspect now that the earlier
use of PRN 4 by SVN36 was some kind of control segment testing in advance
of the launch of SVN74.

## GPS Constellation Status 2019-02-20

The Global Positioning Systems Directoriate proposed a change to the
"Navstar GPS Control Segment to User Support Community Interfaces"
(ICD-GPS-240 and ICD-GPS-87-) to modify the GPS Operational Advisory
Message to eliminate information about the orbital plane/slot and clock.
This change was approved by the Interface Control Working Group on
2018-12. I've captured a portion of a recent Advisory Message here to
snapshot this information before it is lost.

    GPS Constellation Active Nanu Status 2/20/19
    Plane       Slot    SVN     PRN     Block   Clock
    A           1       65      24      IIF     CS      
    A           2       52      31      IIR-M   RB      
    A           3       64      30      IIF     RB      
    A           4       48      7       IIR-M   RB      
    B           1       56      16      IIR     RB      
    B           2       62      25      IIF     RB      
    B           3       44      28      IIR     RB      
    B           4       58      12      IIR-M   RB      
    B           5       71      26      IIF     RB      
    C           1       57      29      IIR-M   RB      
    C           2       66      27      IIF     RB      
    C           3       72      8       IIF     CS      
    C           4       53      17      IIR-M   RB      
    C           5       59      19      IIR     RB      
    D           1       61      2       IIR     RB      
    D           2       63      1       IIF     RB      
    D           3       45      21      IIR     RB      
    D           4       67      6       IIF     RB      
    D           5       46      11      IIR     RB      
    D           6       34      18      IIA     RB
    E           1       69      3       IIF     RB      
    E           2       73      10      IIF     RB      
    E           3       50      5       IIR-M   RB      
    E           4       51      20      IIR     RB      
    E           6       47      22      IIR     RB      
    F           1       70      32      IIF     RB      
    F           2       55      15      IIR-M   RB      
    F           3       68      9       IIF     RB      
    F           4       60      23      IIR     RB      
    F           5       41      14      IIR     RB      
    F           6       43      13      IIR     RB      

    GPS Expandable Slot Designations
    B5=B1F
    D5=D2F
    F5=F2F
    B1=B1A
    D2=D2A
    F2=F2A

## U-Blox ZED-F9P Bug

The Ardusimple SimpleRTK2B board uses the U-Blox ZED-F9P GPS receiver.
I'm pretty sure the firmware in the ZED-F9P-00B-01 chip on my SimpleRTK2B
board has a bug. I believe this GSV sentence that it emitted is incorrect.

    $GLGSV,3,3,11,85,26,103,25,86,02,152,29,1*75\r\n

This GSV sentence says it is the third of three GSV sentences for the
GLONASS constellation, and there are eleven total satellites cited in
the three GSV sentences.

GSV is unusual amongst the typical NMEA sentences in that it is variable
length. Each GSV sentence can contain at most four satellites, each
represented by four numbers: the space vehicle ID (which is specific to
the constellation), the SV's elevation in degrees, the SV's azimuth in
degrees, and the signal strength in dB Hz.

The two prior GSV sentences for this report of GLONASS satellites in
view would have had at most four satellites, for a total of eight,
leaving three satellites for this final sentence in the sequence. This
sentence only has the metrics for two satellites. Note also that this
messages has the optional signal identifier as its last field before
the checksum.

I think either there should be a third set of four fields for the eleventh
satellite, or the total count should be ten instead of eleven. My software
has been modified to account for this malformed message; it originally
core dumped with a segmentation violation.

## Ardusimple SimpleRTK2B

The Ardusimple SimpleRTK2B board features a ZED-F9P "9th generation" U-Blox
chip. It can be equipped with radios like the ZigBee-based XBee. This allows
one SimpleRTK2B to be used as a stationary "base" in high-precision "survey-in"
mode, and a second SimpleRTK2B in mobile "rover" mode; the base transmits
position corrections to the rover via the radio using the RTCM protocol once
the survey has been completed to the configured level of accuracy. This
is a form of Differential GNSS and can, over time, achieve very high position
(and time) accuracy and precision.

### Block Diagram

                                Radio Antenna
                                      :
                                [ XBee3 SX ]
                                      ^ 
                                      | 
                                      v 
                     Header <--> XBee UART <--> FTDI <--> USB <--> XCTU
                                      ^
                                      |
                                      v
                                  UBX UART2
                                      |
                                      v
    Header <--> UBX UART1 <--> [ UBX-ZED-F9P ] <--> USB <--> u-center or gpstool
                                      :
                                  GPS Antenna

In the diagram above I show where you would connect the XBee configuration tool
XCTU, or the u-blox configuration tool u-center, but in normal use I only have
a host running gpstool connected.

I used XCTU to configure the XBee radio (setting it to Transparent mode, as a
Zigbee Router, and a serial port baud rate of 38400 8N1) and persist that
configuration in the XBee's non-volatile memory.

The ZED-F9P is configured at run-time using gpstool to send it commands. This
configuration is in volatile memory so that the GPS receiver reverts back to its
factory defaults when it is power cycled. Among other things, this allows me to
use SimpleRTK2B boards interchangeably in the field.

### Base Configuration

    $ simplertk2bbase /dev/ttyACM0
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    END gpstool: LAST.
    END gpstool: END.

    $ simplertk2bquery /dev/ttyACM0
    UBX gpstool: MON VER SW "EXT CORE 1.00 (94e56e)"
    UBX gpstool: MON VER HW "00190000"
    UBX gpstool: MON VER EX "ROM BASE 0x118B2060"
    UBX gpstool: MON VER EX "FWVER=HPG 1.11"
    UBX gpstool: MON VER EX "PROTVER=27.10"
    UBX gpstool: MON VER EX "MOD=ZED-F9P"
    UBX gpstool: MON VER EX "GPS;GLO;GAL;BDS"
    UBX gpstool: MON VER EX "QZSS"
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20930001 0x29
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20030001 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x40030010 0x0000003c
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x40030011 0x000186a0
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x40530001 0x00009600
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20530002 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20530003 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20530004 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x10530005 0x1
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x209102bf 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20910360 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20910365 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091036a 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091036f 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20910305 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x10750004 0x0
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x10760004 0x1
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091008b 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091026b 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    END gpstool: LAST.
    END gpstool: END.

### Rover Configuration

    $ simplertk2brover /dev/ttyACM1
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    UBX gpstool: ACK 0x06 0x8a (1)
    END gpstool: LAST.
    END gpstool: END.

    $ simplertk2bquery /dev/ttyACM1
    UBX gpstool: MON VER SW "EXT CORE 1.00 (94e56e)"
    UBX gpstool: MON VER HW "00190000"
    UBX gpstool: MON VER EX "ROM BASE 0x118B2060"
    UBX gpstool: MON VER EX "FWVER=HPG 1.11"
    UBX gpstool: MON VER EX "PROTVER=27.10"
    UBX gpstool: MON VER EX "MOD=ZED-F9P"
    UBX gpstool: MON VER EX "GPS;GLO;GAL;BDS"
    UBX gpstool: MON VER EX "QZSS"
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20930001 0x29
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20030001 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x40030010 0x00000000
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x40030011 0x00000000
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x40530001 0x00009600
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20530002 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20530003 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20530004 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x10530005 0x1
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x209102bf 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20910360 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20910365 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091036a 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091036f 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x20910305 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x10750004 0x1
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x10760004 0x0
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091008b 0x00
    UBX gpstool: ACK 0x06 0x8b (1)
    UBX gpstool: CFG VALGET v1 RAM [0] 0x2091026b 0x01
    UBX gpstool: ACK 0x06 0x8b (1)
    END gpstool: LAST.
    END gpstool: END.

# Acknowledgements

Special thanks to Mrs. Overclock for her assistance in road testing (literally)
this software.
